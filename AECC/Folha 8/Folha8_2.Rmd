---
title: "Exercícios de Regressão Logística"
author: ""
output: html_document
fontsize: 11pt
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Exercício 1 – Probabilidade de doença em função do tabagismo

Um estudo simples em saúde pública pretendeu perceber a relação entre **tabagismo** e uma determinada **doença respiratória crónica**. Foi recolhida informação sobre 300 indivíduos, guardada no ficheiro `saude_fumadores.csv`, com as seguintes variáveis:

* `doenca` – variável binária:

  * `1` se o indivíduo tem a doença respiratória crónica;
  * `0` caso contrário.
* `fumador` – variável binária:

  * `1` se o indivíduo é fumador atual;
  * `0` se não é fumador atual.
* `idade` – idade do indivíduo (em anos).
* `sexo` – variável categórica com dois níveis: `"F"` e `"M"`.

Pretende-se ajustar um **modelo de regressão logística** para estudar a associação entre tabagismo e doença respiratória, controlando o efeito da idade.

## 1.1 Importação e exploração inicial

1. Leia o ficheiro `saude_fumadores.csv` para R e faça uma breve inspeção dos dados.

```{r exercicio1-importacao}
library(ggplot2)
library(dplyr)
library(tibble)
dados_saude <- read.csv("saude_fumadores.csv")
head(dados_saude)
```

2. Produza algumas tabelas e gráficos exploratórios simples, por exemplo:

   * tabela de frequências de `doenca` e `fumador`;
   * gráfico de barras cruzando `doenca` e `fumador`;
   * boxplot de `idade` por `doenca`.

Comente **pelo menos duas observações** interessantes (por exemplo, se a doença parece mais frequente em fumadores, se os doentes são em média mais velhos, etc.).

```{r exercicio1-exploracao}
# Tabela de frequências
table(Doenca = dados_saude$doenca, Fumador = dados_saude$fumador)

# Gráfico de barras
ggplot(dados_saude, aes(x = factor(fumador), fill = factor(doenca))) +
  geom_bar(position = "dodge") + # "dodge" coloca as barras lado a lado
  scale_x_discrete(labels = c("Não Fumador", "Fumador")) +
  scale_fill_manual(values = c("lightblue", "salmon"), 
                    labels = c("Sem Doença", "Com Doença"),
                    name = "Estado") +
  labs(title = "Relação entre Tabagismo e Doença",
       x = "Hábito Tabágico",
       y = "Contagem") +
  theme_minimal()

# Boxplot da idade por doença
ggplot(dados_saude, aes(x = factor(doenca), y = idade, fill = factor(doenca))) +
  geom_boxplot() +
  scale_x_discrete(labels = c("Sem Doença", "Com Doença")) +
  scale_fill_manual(values = c("lightgreen", "orange"), guide = "none") + # guide="none" remove a legenda redundante
  labs(title = "Distribuição de Idade por Grupo",
       x = "Estado de Saúde",
       y = "Idade") +
  theme_minimal()

```
No gráfico de barras, observa-se que a proporção de doentes (barra salmão) é visivelmente maior no grupo de fumadores (1) do que nos não fumadores.

No boxplot, é provável que a mediana da idade dos indivíduos com doença seja superior à dos sem doença, sugerindo que a idade é um fator de risco ou confundimento.

## 1.2 Modelo de regressão logística simples

3. Comece por ajustar um modelo de regressão logística com:

$$
\text{Resposta: }\texttt{doenca}, \quad \text{Covariável: }\texttt{fumador}
$$

isto é, um modelo com **apenas uma covariável** (`fumador`).

```{r exercicio1-logistico-simples}
mod1 <- glm(doenca ~ fumador, data = dados_saude, family = binomial)
summary(mod1)
```

4. Interprete:

   a) O **sinal** do coeficiente associado a `fumador`.
   b) O **p-valor** associado a esse coeficiente.

   Com base nessa informação, discuta se existe evidência estatística de associação entre tabagismo e doença respiratória.
Sinal: Se $\hat\beta_{fumador} > 0$, indica que ser fumador aumenta as log-odds (e consequentemente a probabilidade) de ter a doença.P-valor: Se o p-valor for baixo (< 0.05), rejeitamos a hipótese nula de que o coeficiente é zero, concluindo que existe evidência estatística significativa de associação entre fumar e a doença.

5. Calcule a **odds ratio** associada à variável `fumador` (fumadores vs. não fumadores) usando o coeficiente do modelo.
   Interprete em linguagem simples.

```{r exercicio1-oddsratio}
exp(coef(mod1)["fumador"])
```

## 1.3 Modelo de regressão logística múltipla

6. Ajuste agora um modelo mais completo, incluindo a idade:

$$
\texttt{doenca} \sim \texttt{fumador} + \texttt{idade}
$$

```{r exercicio1-logistico-multiplo}
mod2 <- glm(doenca ~ fumador + idade, 
            data = dados_saude, 
            family = binomial
)
summary(mod2)
```

7. Compare os modelos `mod1` e `mod2`:

   a) Comente se o coeficiente de `fumador` mudou muito ao incluir a variável `idade`.
Mudança no coeficiente: Compare o $\beta_{fumador}$ do mod1 com o do mod2. Se diminuir muito, sugere que parte do efeito atribuído ao tabagismo era, na verdade, efeito da idade (confundimento).

   b) Discuta o que significa, em termos de interpretação, “o efeito de ser fumador **ajustado** à idade”.
Ajustado à idade: O coeficiente de fumador no mod2 representa o efeito do tabagismo mantendo a idade constante. Ou seja, compara fumadores e não fumadores da mesma idade.

8. Usando o modelo `mod2`, calcule a probabilidade prevista de ter a doença para os seguintes perfis:

   * Perfil A: não fumador, 30 anos;
   * Perfil B: fumador, 30 anos;
   * Perfil C: não fumador, 60 anos;
   * Perfil D: fumador, 60 anos.

```{r exercicio1-probabilidades}
novos_perfis <- data.frame(
  fumador = c(0, 1, 0, 1),
  idade   = c(30, 30, 60, 60),
  row.names = c("Perfil A (NF, 30)", "Perfil B (F, 30)", 
                "Perfil C (NF, 60)", "Perfil D (F, 60)")
)

predict(mod2, newdata = novos_perfis, type = "response")
```

Comente os resultados: em que medida a idade e o tabagismo contribuem para aumentar a probabilidade de doença?
Espera-se ver que a probabilidade aumenta ao passar de Não Fumador para Fumador (comparando A vs B ou C vs D) e aumenta consideravelmente com a idade (comparando A vs C ou B vs D).

## 1.4 Avaliação simples do modelo

9. A partir do modelo `mod2`, obtenha as probabilidades previstas para todos os indivíduos na amostra e transforme-as em **previsões 0/1**, usando um ponto de corte de 0.5.

10. Construa a **matriz de confusão** e calcule a **proporção de classificações corretas** (acerto global). Comente se considera este valor razoável, tendo em conta o contexto.

```{r exercicio1-avaliacao}
probs_mod2 <- predict(mod2, type = "response")
preds_mod2 <- ifelse(probs_mod2 >= 0.5, 1, 0)

tab_confusao <- table(Observado = dados_saude$doenca, Previsto = preds_mod2)
print(tab_confusao)

# Acerto Global (Accuracy)
accuracy <- sum(diag(tab_confusao)) / sum(tab_confusao)
accuracy
```
Se a accuracy for alta (ex: > 0.8), o modelo classifica bem. Contudo, em saúde, devemos ter atenção aos falsos negativos.

11. (Questão conceptual) Discuta uma **limitação** de usar apenas o ponto de corte 0.5 e a percentagem de acerto para avaliar um modelo de regressão logística (por exemplo, em situações em que a doença é rara).
Limitação do corte 0.5: Se a doença for rara (ex: apenas 5% da amostra tem a doença), o modelo pode prever "0" para toda a gente e ter 95% de accuracy, mas ser inútil clinicamente porque não deteta nenhum doente (Sensibilidade = 0). O threshold deve ser ajustado conforme o "custo" do erro.

---

# Exercício 2 – Aprovação de alunos em função dos hábitos de estudo

Numa disciplina de Estatística, foi recolhida informação sobre 200 alunos, guardada no ficheiro `alunos_aprovacao.csv`. As variáveis são:

* `aprovado` – variável binária:

  * `1` se o aluno foi aprovado na disciplina;
  * `0` se foi reprovado.
* `horas_estudo` – número médio de horas de estudo por semana.
* `frequencia_aulas` – percentagem de aulas assistidas (entre 0 e 100).
* `trabalhador` – variável binária:

  * `1` se o aluno trabalha em part-time;
  * `0` caso contrário.
* `media_secundario` – média final (0–20) obtida no ensino secundário.

Pretende-se ajustar modelos de regressão logística para estudar os fatores associados à aprovação.

## 2.1 Importação e exploração dos dados

1. Leia o ficheiro `alunos_aprovacao.csv` e faça uma breve exploração descritiva:

   * tabelas de frequências para `aprovado` e `trabalhador`;
   * estatísticas resumo para `horas_estudo`, `frequencia_aulas` e `media_secundario`;
   * um ou dois gráficos sugeridos por si (por exemplo, boxplot de `horas_estudo` por `aprovado`).

```{r exercicio2-importacao}
dados_alunos <- read.csv("alunos_aprovacao.csv")

# Tabelas e estatísticas
table(Aprovado = dados_alunos$aprovado, Trabalhador = dados_alunos$trabalhador)
summary(dados_alunos[, c("horas_estudo", "frequencia_aulas", "media_secundario")])

# Boxplot sugerido
boxplot(horas_estudo ~ aprovado, data = dados_alunos,
        col = c("grey80", "lightblue"),
        main = "Horas de Estudo vs Aprovação",
        xlab = "Aprovado (0=Não, 1=Sim)", ylab = "Horas/semana")
```

Comente **duas observações** sobre o comportamento dos alunos (por exemplo, se os aprovados tendem a estudar mais, se há grandes diferenças na frequência às aulas, etc.).

## 2.2 Modelo logístico com múltiplas covariáveis

2. Ajuste um modelo de regressão logística com:

$$
\texttt{aprovado} \sim \texttt{horas_estudo} + \texttt{frequencia_aulas} + \texttt{trabalhador}
$$

```{r exercicio2-logistico1}
mod_alunos1 <- glm(aprovado ~ horas_estudo + frequencia_aulas + trabalhador, 
                   data = dados_alunos, family = binomial)
summary(mod_alunos1)
```

3. Interprete:

   a) Os sinais dos coeficientes de `horas_estudo` e `frequencia_aulas`.
   b) Os respetivos p-valores.

   Com base nisso, discuta se estes fatores parecem estar associados à probabilidade de aprovação.
$\beta_{horas}$ e $\beta_{freq}$: Esperam-se sinais positivos (mais estudo e frequência aumentam a probabilidade de aprovação).P-valores: Indicam se estas variáveis são estatisticamente relevantes para explicar a aprovação.

4. Calcule e interprete a **odds ratio** para a variável `trabalhador`:

   * `trabalhador = 1` vs. `trabalhador = 0`,
     mantendo constantes as restantes variáveis.

```{r exercicio2-oddsratio-trabalhador}
exp(coef(mod_alunos1)["trabalhador"])
```
Se o valor for < 1 (ex: 0.6), trabalhar diminui a chance de aprovação (odds 40% menor), mantendo constantes as horas de estudo e frequência.
Se for > 1, trabalhar estaria associado a maior sucesso (talvez por maior maturidade/organização), ceteris paribus.
Comente se trabalhar em part-time parece estar associado a maior ou menor probabilidade de aprovação.

## 2.3 Inclusão da média do secundário

5. Ajuste agora um modelo mais completo com todas as covariáveis:

$$
\texttt{aprovado} \sim \texttt{horas_estudo} + \texttt{frequencia_aulas} + \texttt{trabalhador} + \texttt{media_secundario}
$$

```{r exercicio2-logistico2}
mod_alunos2 <- glm(aprovado ~ horas_estudo + frequencia_aulas + trabalhador + media_secundario, 
                   data = dados_alunos, family = binomial)
summary(mod_alunos2)
```

6. Compare `mod_alunos1` e `mod_alunos2`:

   a) Comente se a inclusão de `media_secundario` altera o coeficiente (e/ou significância) de alguma das outras variáveis.
   b) Discuta o que significa, neste contexto, interpretar o efeito de `horas_estudo` **ajustado** à média do secundário.
Ao incluir a media_secundario (que é um forte preditor de capacidade académica prévia), os coeficientes de horas_estudo podem diminuir. Isso acontece se os alunos que estudam mais forem também os que já tinham melhores médias antes.
Interpretação ajustada: O efeito das horas_estudo agora é o ganho na probabilidade de passar comparando dois alunos com a mesma média de entrada e frequência.

## 2.4 Probabilidades previstas para perfis de alunos

7. Usando o modelo `mod_alunos2`, calcule as probabilidades previstas de aprovação para os seguintes perfis:

   * Perfil 1: `horas_estudo = 2`, `frequencia_aulas = 60`, `trabalhador = 1`, `media_secundario = 12`.
   * Perfil 2: `horas_estudo = 8`, `frequencia_aulas = 90`, `trabalhador = 0`, `media_secundario = 12`.
   * Perfil 3: `horas_estudo = 5`, `frequencia_aulas = 80`, `trabalhador = 0`, `media_secundario = 17`.

```{r exercicio2-probabilidades}
perfis_alunos <- data.frame(
  horas_estudo = c(2, 8, 5),
  frequencia_aulas = c(60, 90, 80),
  trabalhador = c(1, 0, 0),
  media_secundario = c(12, 12, 17)
)
row.names(perfis_alunos) <- c("Perfil 1 (Fraco)", "Perfil 2 (Médio/Esforçado)", "Perfil 3 (Bom aluno)")

predict(mod_alunos2, newdata = perfis_alunos, type = "response")
```

Comente os resultados, discutindo:

* o impacto das horas de estudo e da frequência às aulas;
* o papel da média do secundário;
* se faz sentido que alunos com melhor média no secundário tenham, em geral, maior probabilidade de aprovação.

O Perfil 2 (muito estudo, média 12) deve ter probabilidade maior que o Perfil 1 (pouco estudo, trabalhador, média 12).

O Perfil 3 (estudo médio, mas média secundário 17) deve ter uma probabilidade muito alta, mostrando o peso do histórico escolar ("bagagem").

## 2.5 Avaliação e pensamento crítico

8. Obtenha as probabilidades previstas de aprovação para todos os alunos e construa uma matriz de confusão usando o ponto de corte 0.5. Calcule a proporção de classificações corretas.

```{r exercicio2-avaliacao}
probs_alunos <- predict(mod_alunos2, type = "response")
preds_alunos <- ifelse(probs_alunos >= 0.5, 1, 0)

tab_alunos <- table(Observado = dados_alunos$aprovado, Previsto = preds_alunos)
tab_alunos

accuracy_alunos <- sum(diag(tab_alunos)) / sum(tab_alunos)
accuracy_alunos
```

9. Discuta, em texto, as seguintes questões:

   a) A taxa de acerto parece satisfatória? Porquê?
Satisfatória? Depende do valor. Acima de 75-80% costuma ser bom em ciências sociais/educação.
   b) O modelo está a errar mais frequentemente nos aprovados ou nos reprovados? Que implicações isso poderia ter em termos de decisão (por exemplo, identificar alunos em risco)?
Tipo de erro: Olhe para os Falsos Negativos (Observado 1, Previsto 0) vs Falsos Positivos.
Se o modelo erra muito nos reprovados (prevê que passam, mas reprovam), é arriscado pois não sinalizamos alunos que precisam de ajuda.
   c) Sugira **uma alteração possível** ao modelo ou à forma como é avaliado (por exemplo, considerar outro ponto de corte, incluir uma interação, recolher uma nova variável) e justifique por que poderia ser útil.
Interação: Poderia haver interação entre horas_estudo e media_secundario (o estudo rende mais a quem tem melhor base?).
Threshold: Se queremos detetar alunos em risco de reprovar (para dar apoio tutorial), devemos subir o threshold (ex: classificar como "vai passar" só se Prob > 0.7). Isso aumentaria a deteção de reprovados (classe 0), embora com mais falsos alarmes.

